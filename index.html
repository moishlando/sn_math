<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monospace Math Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
  <script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #1e1e1e;
      color: #f5f5f5;
      font-family: monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #editor {
      flex: 1;
      padding: 15px;
      outline: none;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    strong {
      font-weight: bold;
      color: #ffd700;
    }
  </style>
</head>
<body>
  <div id="editor" contenteditable="true"></div>

  <script>
    const editor = document.getElementById('editor');

    // Convert **bold** into <strong>
    function renderBold(text) {
      return text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    }

    // Replace math inline with MathLive fields
    function renderMath() {
      const raw = editor.innerText;
      let html = renderBold(raw);

      // Replace $...$ or $$...$$
      html = html.replace(/\$\$(.+?)\$\$|\$(.+?)\$/g, (match, block, inline) => {
        const expr = block || inline;
        return `<span class="mathfield" data-content="${expr}"></span>`;
      });

      editor.innerHTML = html;

      // Upgrade math spans to interactive MathLive fields
      document.querySelectorAll('.mathfield').forEach(el => {
        const mf = MathLive.makeMathField(el, {
          defaultMode: 'math',
          virtualKeyboardMode: 'off',
          smartMode: false,
          onContentDidChange: (mf) => syncBack(),
        });
        mf.setValue(el.dataset.content);
      });

      syncBack();
    }

    // Send text back to Standard Notes
    function syncBack() {
      let text = editor.innerText;

      // Convert MathLive fields back to $...$
      document.querySelectorAll('.mathfield').forEach(el => {
        const latex = el.querySelector('math-field')?.getValue() || el.dataset.content;
        text = text.replace(el.innerText, `$${latex}$`);
      });

      window.parent.postMessage({ action: "set-text", text }, "*");
    }

    // Standard Notes â†’ load note content
    window.addEventListener("message", (event) => {
      if (event.data.action === "set-text") {
        editor.innerText = event.data.text || "";
        renderMath();
      }
    });

    // Initial demo
    editor.innerText = "Notes here. Bold with **stars**. Inline math: $x^2+y^2=z^2$ or $$E=mc^2$$.";
    renderMath();
  </script>
</body>
</html>
